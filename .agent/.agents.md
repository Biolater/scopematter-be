---
description: Context Engineering: Architectural Constraints & Governance
---

# ðŸ§  ScopeMatter Backend Context & Governance rules

This file serves as the **Constitution** for all AI Agents and Human Developers working on this codebase. It enforces the "Senior" patterns required to maintain the "Trust Engine".

## 1. The Supreme Directive: "Trust Over Speed"
*   **No "Magic" Code**: All logic must be explicit. Avoid "clever" one-liners that obscure intent.
*   **Immutability First**: Status transitions (Pending -> Approved) are one-way doors. Once data is closed, it is locked.

## 2. Architectural Patterns (Enforced)

### The "Validation Boundary" Pattern
*   **Constraint**: NO external input (req.body, req.query) may enter the Service Layer without passing through a Zod Schema first.
*   **Why**: "Parse, don't validate." We do not trust the client.
*   **Implementation**: Use `validateBody(Schema)` middleware on every POST/PUT route.

### The "Sovereign ID" Pattern
*   **Constraint**: `clerkId` is the Authentication ID, but `AppUser.id` (CUID) is the Referential ID.
*   **Why**: We decouple our domain data from the Auth Provider. If we switch from Clerk to Auth0, our DB relations remain intact.

### The "Dumb Controller" Pattern
*   **Constraint**: Controllers must NOT contain business logic.
*   **Role**:
    1.  Extract Data (req.body, req.user)
    2.  Call Service
    3.  Return Standardized Response (`sendSuccess`)
*   **Why**: Logic trapped in controllers cannot be unit tested or reused.

### The "Repository-Less" Usage (Prisma)
*   **Constraint**: We use Prisma Client *directly* in the Service Layer. Do not build a generic "Repository Pattern" wrapper.
*   **Why**: Prisma *is* the repository pattern. Wrapping it adds abstraction without value.

## 3. Deployment & Orchestration
*   **Docker Mandatory**: All new dependencies (e.g., if we add Queueing) must be added to `docker-compose.yml`.
*   **Parity**: The `Dockerfile` configuration must match the `ci.yml` environment.

## 4. Error Handling Protocol
*   **Throwing**: Services should throw `ServiceError` (Domain/Business rule codes).
*   **Catching**: The Global Error Handler maps these to HTTP 400/404/403.
*   **Forbidden**: Never manually send `res.status(500)` from a controller. Let the handler do it.
